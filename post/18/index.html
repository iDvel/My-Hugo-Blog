<!DOCTYPE html>
<html lang="zh-Hans" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>《Flask Web 开发》笔记 - Dvel&#39;s Blog</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="Dvel" />
  <meta name="description" content="《Flask Web 开发》 #### 粗略的记录了一些大纲、每小节重点、难点、可能会遗忘、懒得记忆、方便查阅的东西，配合目录查阅。 第 1 章 - 安装 Flask 哲学 Flask 自开发" />

  <meta name="keywords" content="Dvel" />


<meta name="baidu-site-verification" content="SuLNTY16ns" />
<meta name="google-site-verification" content="TBsJFrrOXdnvNzVNaVSdgDOfCpOes1ZRRqCXbDsyC7c" />


<meta name="generator" content="Hugo 0.57.2" />


<link rel="canonical" href="https://Dvel.xyz/post/18/" />



<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.ec807d8b802a40889537c26e014f733206312ea440d42e1f0dabed80918de1ac.css" integrity="sha256-7IB9i4AqQIiVN8JuAU9zMgYxLqRA1C4fDavtgJGN4aw=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="《Flask Web 开发》笔记" />
<meta property="og:description" content="《Flask Web 开发》 #### 粗略的记录了一些大纲、每小节重点、难点、可能会遗忘、懒得记忆、方便查阅的东西，配合目录查阅。 第 1 章 - 安装 Flask 哲学 Flask 自开发" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://Dvel.xyz/post/18/" />
<meta property="article:published_time" content="2019-02-22T06:21:12+08:00" />
<meta property="article:modified_time" content="2019-02-22T06:21:12+08:00" />
<meta itemprop="name" content="《Flask Web 开发》笔记">
<meta itemprop="description" content="《Flask Web 开发》 #### 粗略的记录了一些大纲、每小节重点、难点、可能会遗忘、懒得记忆、方便查阅的东西，配合目录查阅。 第 1 章 - 安装 Flask 哲学 Flask 自开发">


<meta itemprop="datePublished" content="2019-02-22T06:21:12&#43;08:00" />
<meta itemprop="dateModified" content="2019-02-22T06:21:12&#43;08:00" />
<meta itemprop="wordCount" content="3395">



<meta itemprop="keywords" content="Python,Flask," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="《Flask Web 开发》笔记"/>
<meta name="twitter:description" content="《Flask Web 开发》 #### 粗略的记录了一些大纲、每小节重点、难点、可能会遗忘、懒得记忆、方便查阅的东西，配合目录查阅。 第 1 章 - 安装 Flask 哲学 Flask 自开发"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Dvel&#39;s Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://Dvel.xyz/">Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://Dvel.xyz/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://Dvel.xyz/tags/">Tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://Dvel.xyz/friends/">Friends</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://Dvel.xyz/about/">About</a>
          
        
      </li>
    
  </ul>
</nav>


  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      Dvel's Blog
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://Dvel.xyz/">Home</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://Dvel.xyz/post/">Archives</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://Dvel.xyz/tags/">Tags</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://Dvel.xyz/friends/">Friends</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://Dvel.xyz/about/">About</a>
          

        

      </li>
    
    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">《Flask Web 开发》笔记</h1>
      
      <div class="post-meta">
        <time datetime="2019-02-22" class="post-time">
          2019-02-22
        </time>
        
        

        
        
          <span id="busuanzi_container_page_pv">
            | 阅读 <span id="busuanzi_value_page_pv"></span>
          </span>
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#第-1-章-安装">第 1 章 - 安装</a>
<ul>
<li><a href="#flask-哲学">Flask 哲学</a></li>
<li><a href="#venv">venv</a></li>
</ul></li>
<li><a href="#第-2-章-应用的基本结构">第 2 章 - 应用的基本结构</a>
<ul>
<li><a href="#初始化">初始化</a></li>
<li><a href="#路由和视图函数">路由和视图函数</a></li>
<li><a href="#一个完整的应用">一个完整的应用</a></li>
<li><a href="#web-开发服务器">Web 开发服务器</a></li>
<li><a href="#调试模式">调试模式</a></li>
<li><a href="#命令行选项">命令行选项</a></li>
<li><a href="#请求-响应循环">请求-响应循环</a>
<ul>
<li><a href="#上下文">上下文</a></li>
<li><a href="#flask-请求对象-request">Flask 请求对象 (request)</a></li>
<li><a href="#请求钩子">请求钩子</a></li>
<li><a href="#响应">响应</a></li>
</ul></li>
</ul></li>
<li><a href="#第-3-章-模板">第 3 章 - 模板</a>
<ul>
<li><a href="#jinja2-模板引擎">Jinja2 模板引擎</a></li>
<li><a href="#初始化扩展">初始化扩展</a></li>
<li><a href="#自定义错误页面">自定义错误页面</a></li>
<li><a href="#链接">链接</a></li>
</ul></li>
<li><a href="#第-4-章-web-表单">第 4 章 - Web 表单</a>
<ul>
<li><a href="#表单">表单</a></li>
<li><a href="#post-redirect-get-模式">Post / Redirect / Get 模式</a></li>
<li><a href="#闪现消息">闪现消息</a></li>
</ul></li>
<li><a href="#第-5-章-数据库">第 5 章 数据库</a>
<ul>
<li><a href="#flask-sqlalchemy-简单配置-sqlite-数据库">Flask-SQLAlchemy 简单配置 SQLite 数据库</a></li>
<li><a href="#模型-一对多">模型 （一对多）</a></li>
<li><a href="#数据库操作-flask-shell">数据库操作 （flask shell）</a></li>
<li><a href="#集成-python-shell">集成 Python shell</a></li>
</ul></li>
<li><a href="#第-6-章-电子邮件">第 6 章 电子邮件</a></li>
<li><a href="#第-7-章-大型应用的结构">第 7 章 大型应用的结构</a>
<ul>
<li>
<ul>
<li><a href="#项目结构">项目结构：</a></li>
<li><a href="#需求文件-requirements-txt">需求文件 requirements.txt</a></li>
<li><a href="#蓝本">蓝本</a></li>
</ul></li>
</ul></li>
<li><a href="#第-8-章-用户身份验证">第 8 章 用户身份验证</a></li>
<li><a href="#涉及到的-pip-包">涉及到的 pip 包</a></li>
</ul></li>
</ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      

<p>《Flask Web 开发》</p>

<blockquote>
<p>#### 粗略的记录了一些大纲、每小节重点、难点、可能会遗忘、懒得记忆、方便查阅的东西，配合目录查阅。</p>
</blockquote>

<h2 id="第-1-章-安装">第 1 章 - 安装</h2>

<h3 id="flask-哲学">Flask 哲学</h3>

<p>Flask 自开发伊始就被设计为可扩展的框架，它具有一个包含基本服务的强健核心，其他功能则可通过扩展实现。</p>

<p>Flask 有 3 个主要依赖：</p>

<ul>
<li>路由、调试和 Web 服务器网关接口（WSGI，Web server gateway interface）子系统由 Werkzeug 提供；</li>
<li>模板系统由 Jinja2 提供；</li>
<li>命令行集成由 Click 提供。</li>
</ul>

<p>开发者可以任意挑选符合项目需求的扩展，甚至可以自行开发。这和大型框架的做法相反，大型框架往往已经替你做出了大多数决定，难以（有时甚至不允许）使用替代方案。</p>

<h3 id="venv">venv</h3>

<p>在 Python 3 中由标准库 <code>venv</code> 创建虚拟环境：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">$ python3 -m venv virtual-environment-name</pre></td></tr></table>
</div>
</div>
<p>激活虚拟环境：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">$ source venv/bin/activate</pre></td></tr></table>
</div>
</div>
<p>取消：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">$ deactivate</pre></td></tr></table>
</div>
</div>
<p><br/></p>

<h2 id="第-2-章-应用的基本结构">第 2 章 - 应用的基本结构</h2>

<h3 id="初始化">初始化</h3>

<p>所有 Flask 应用都必须创建一个<strong>应用实例</strong>，通常由下述代码创建：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>Web 服务器使用 WSGI 协议，把接受自客户端的所有请求转发给这个对象处理。</p>

<h3 id="路由和视图函数">路由和视图函数</h3>

<p>客户端(浏览器)把请求发送给 Web 服务器，Web 服务器再把请求发送给 Flask 应用实例。</p>

<p>应用实例需要知道对每个 URL 的请求要运行哪些代码，所有保存了一个 URL 到 Python 函数的映射关系。</p>

<p>处理 URL 和函数之间关系的程序称为<strong>路由</strong>。</p>

<p>Flask 使用  <code>app.route</code> 装饰器或者更传统的 <code>app.add_url_rule()</code> 方法构建映射：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/user/&lt;name&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">user</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;&lt;h1&gt;Hello {}!&lt;/h1&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;&lt;h1&gt;Hello World!&lt;/h1&gt;&#39;</span>
<span class="n">app</span><span class="o">.</span><span class="n">add_url_rule</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p><code>index()</code> 这样处理入站请求的函数称为<strong>视图函数</strong>。</p>

<h3 id="一个完整的应用">一个完整的应用</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;&lt;h1&gt;Hello World!&lt;/h1&gt;&#39;</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="web-开发服务器">Web 开发服务器</h3>

<p>Flask 自带 Web 开发服务器，通过 <code>flask run</code> 命令启动。这个命令在 <code>FLASK_APP</code> 环境变量指定的 Python 脚本中寻找应用实例。</p>

<h3 id="调试模式">调试模式</h3>

<p>Flask 应用可以在<strong>调试模式</strong>中运行，在调试模式下，开发服务器会默认加载<strong>重载器</strong>和<strong>调试器</strong>。</p>

<p><strong>重载器：</strong>Flask 会监视项目中的所有源码文件，发现变动时自动重启服务器。</p>

<p><strong>调试器：</strong>调试器是一个基于 Web 的工具，当应用抛出未处理的异常时，它会出现在浏览器中。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ <span class="nb">export</span> <span class="nv">FLASK_APP</span><span class="o">=</span>hello.py
$ <span class="nb">export</span> <span class="nv">FLASK_DEBUG</span><span class="o">=</span><span class="m">1</span>
（或本行）$ <span class="nb">export</span> <span class="nv">FLASK_ENV</span><span class="o">=</span>development 效果同上<span class="o">)</span>
$ flask run</code></pre></td></tr></table>
</div>
</div>
<h3 id="命令行选项">命令行选项</h3>

<p><code>flask shell</code> 命令在应用上下文中打开一个 Python shell 会话，可以运行维护任务、测试、调试问题。</p>

<h3 id="请求-响应循环">请求-响应循环</h3>

<h4 id="上下文">上下文</h4>

<p>为了避免大量可有可无的参数把视图函数弄得一团糟，Flask 使用上下文临时把某些对象变为全局可访问。在多线程服务器中，Flask 使用上下文让特点的变量在一个线程中全局可访问，与此同时不会干扰其他线程。</p>

<table>
<thead>
<tr>
<th>变量名</th>
<th>上下文</th>
<th>说明</th>
</tr>
</thead>

<tbody>
<tr>
<td>current_app</td>
<td>应用上下文</td>
<td>当前应用的应用实例</td>
</tr>

<tr>
<td>g</td>
<td>应用上下文</td>
<td>处理请求时用作临时存储的对象，每次请求都会重设这个变量</td>
</tr>

<tr>
<td>request</td>
<td>请求上下文</td>
<td>请求对象，封装了客户端发出的 HTTP 请求中的内容</td>
</tr>

<tr>
<td>session</td>
<td>请求上下文</td>
<td>用户会话，值为一个字典，存储请求之间需要『记住』的值</td>
</tr>
</tbody>
</table>

<h4 id="flask-请求对象-request">Flask 请求对象 (request)</h4>

<table>
<thead>
<tr>
<th>属性或方法</th>
<th>说明</th>
</tr>
</thead>

<tbody>
<tr>
<td>form</td>
<td>一个字典，存储请求提交的所有表单字段</td>
</tr>

<tr>
<td>args</td>
<td>一个字典，存储通过 URL 查询字符串传递的所有参数</td>
</tr>

<tr>
<td>values</td>
<td>一个字典，form 和 args 的合集</td>
</tr>

<tr>
<td>cookies</td>
<td>一个字典，存储请求的所有 cookies</td>
</tr>

<tr>
<td>headers</td>
<td>一个字典，存储请求的所有 HTTP 首部</td>
</tr>

<tr>
<td>files</td>
<td>一个字典，存储请求上传的所有文件</td>
</tr>

<tr>
<td>get_data()</td>
<td>返回请求主体缓冲的数据</td>
</tr>

<tr>
<td>get_json()</td>
<td>返回一个 Python 字典，包含解析请求主体后得到的 JSON</td>
</tr>

<tr>
<td>blueprint</td>
<td>处理请求的 Flask 蓝本的名称；蓝本在第 7 章介绍</td>
</tr>

<tr>
<td>endpoint</td>
<td>处理请求的 Flask 端点的名称；Flask 把视图函数的名称用作路由端点的名称</td>
</tr>

<tr>
<td>scheme</td>
<td>URL 方案（http 或 https）</td>
</tr>

<tr>
<td>is_secure()</td>
<td>通过安全的连接（HTTPS）发送请求时返回 True</td>
</tr>

<tr>
<td>host</td>
<td>请求定义的主机名，如果客户端定义了端口号，还包括端口号</td>
</tr>

<tr>
<td>path</td>
<td>URL 的路径部分</td>
</tr>

<tr>
<td>query_string</td>
<td>URL 的查询字符串部分，返回原始二进制值</td>
</tr>

<tr>
<td>full_path</td>
<td>URL 的路径和查询字符串部分</td>
</tr>

<tr>
<td>url</td>
<td>客户端请求的完整 URL</td>
</tr>

<tr>
<td>base_url</td>
<td>同 url，但没有查询字符串部分</td>
</tr>

<tr>
<td>remote_addr</td>
<td>客户端的 IP 地址</td>
</tr>

<tr>
<td>environ</td>
<td>请求的原始 WSGI 环境字典</td>
</tr>
</tbody>
</table>

<h4 id="请求钩子">请求钩子</h4>

<p>有时在处理请求之前或之后执行代码会很有用，但为了避免每个视图函数中都重复编写代码，Flask 提供了注册通用函数的功能，通过装饰器实现。</p>

<table>
<thead>
<tr>
<th>装饰器</th>
<th>说明</th>
</tr>
</thead>

<tbody>
<tr>
<td><code>before_request</code></td>
<td>注册一个函数，在每次请求之前运行。</td>
</tr>

<tr>
<td><code>before_first_request</code></td>
<td>注册一个函数，只在处理第一个请求之前运行。可以通过这个钩子添加服务器初始化任务。</td>
</tr>

<tr>
<td><code>after_request</code></td>
<td>注册一个函数，如果没有未处理的异常抛出，在每次请求之后运行。</td>
</tr>

<tr>
<td><code>teardown_request</code></td>
<td>注册一个函数，即使有未处理的异常抛出，也在每次请求之后运行。</td>
</tr>
</tbody>
</table>

<p>在请求钩子函数和视图函数之间共享数据一般使用上下文全局变量 <code>g</code>。</p>

<h4 id="响应">响应</h4>

<p>如果视图函数返回的响应需要使用不同的状态码，可以把数字代码作为第二个返回值。</p>

<p>Flask 视图函数还可以返回一个响应对象——<code>make_response()</code>。</p>

<p>重定向，由于使用频繁，Flask 提供了 <code>redirect()</code> 辅助函数。</p>

<p><br/></p>

<h2 id="第-3-章-模板">第 3 章 - 模板</h2>

<h3 id="jinja2-模板引擎">Jinja2 模板引擎</h3>

<p><strong>渲染模板</strong></p>

<p>Flask 提供的 <code>render_template()</code> 函数把 Jinja2 模板引擎集成到了应用中。</p>

<p><strong>变量</strong></p>

<p>模板中使用 <code>{{ name }}</code> 结构表示一个变量，支持复杂类型如列表、字典、对象。</p>

<p>支持过滤器：<code>{{ name|capitalize }}</code>。</p>

<p>支持结构控制、宏（类似函数）。</p>

<p>支持模板继承：<code>{% extends &quot;bootstrap/base.html&quot; %}</code> 及 <code>{{ super() }}</code>。</p>

<h3 id="初始化扩展">初始化扩展</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">bootstrap</span> <span class="o">=</span> <span class="n">Bootstrap</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="c1"># 第 7 章中大型应用初始化扩展的方式：</span>
<span class="n">bootstrap</span> <span class="o">=</span> <span class="n">Bootstrap</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">create_app</span><span class="p">(</span><span class="n">config_name</span><span class="p">):</span>
  <span class="c1"># ...</span>
  <span class="n">bootstrap</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
  <span class="c1"># ...</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="自定义错误页面">自定义错误页面</h3>

<p>使用 <code>@app.errorhandler(404)</code> 装饰器。</p>

<h3 id="链接">链接</h3>

<p><code>url_for()</code> 辅助函数帮助在模板中构建正确的 URL。</p>

<p>用法：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># 以视图函数名作为参数，以 app.add_url_route() 定义路由时，使用端点名</span>
<span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span> <span class="c1"># /</span>

<span class="c1"># 绝对地址</span>
<span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">_external</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c1"># http://localhost:5000/</span>

<span class="c1"># 动态 URL</span>
<span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;john&#39;</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># /user/john?page=2&amp;version=1</span></code></pre></td></tr></table>
</div>
</div>
<p><br/></p>

<h2 id="第-4-章-web-表单">第 4 章 - Web 表单</h2>

<h3 id="表单">表单</h3>

<p>使用 <code>Flask-WTF</code>  定义表单：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">flask_wtf</span> <span class="kn">import</span> <span class="n">FlaskForm</span>
<span class="kn">from</span> <span class="nn">wtforms</span> <span class="kn">import</span> <span class="n">StringField</span><span class="p">,</span> <span class="n">SubmitField</span>
<span class="kn">from</span> <span class="nn">wtforms.validators</span> <span class="kn">import</span> <span class="n">DataRequired</span>

<span class="k">class</span> <span class="nc">NameForm</span><span class="p">(</span><span class="n">FlaskForm</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="s1">&#39;What is your name?&#39;</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">DataRequired</span><span class="p">()])</span>
    <span class="n">submit</span> <span class="o">=</span> <span class="n">SubmitField</span><span class="p">(</span><span class="s1">&#39;Submit&#39;</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>使用 <code>Flask-Bootstrap</code> 提供的高层级辅助函数 <code>quick_form()</code> 渲染 <code>Flask-WTF</code> 表单：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span></pre></td>
<td class="lntd">
<pre class="chroma">{% import &#34;bootstrap/wtf.html&#34; as wtf %}
{{ wtf.quick_form(form) }}</pre></td></tr></table>
</div>
</div>
<p>在视图函数中处理表单：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">name</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">NameForm</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate_on_submit</span><span class="p">():</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">data</span>
        <span class="n">form</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="post-redirect-get-模式">Post / Redirect / Get 模式</h3>

<p>Post / Redirect / Get 简称 PRG，是一种用来防止表单重复提交数据的一种 Web 设计模式。</p>

<h3 id="闪现消息">闪现消息</h3>

<p><code>flaks.flash</code> 的简单使用。</p>

<p><br/></p>

<h2 id="第-5-章-数据库">第 5 章 数据库</h2>

<h3 id="flask-sqlalchemy-简单配置-sqlite-数据库">Flask-SQLAlchemy 简单配置 SQLite 数据库</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>

<span class="n">basedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SQLALCHEMY_DATABASE_URI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sqlite:///&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">basedir</span><span class="p">,</span> <span class="s1">&#39;data.sqlite&#39;</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SQLALCHEMY_TRACK_MODIFICATIONS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="n">app</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="模型-一对多">模型 （一对多）</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">Role</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;roles&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">users</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s1">&#39;role&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;Role </span><span class="si">%r</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>


<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;users&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">role_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;roles.id&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;User </span><span class="si">%r</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span></code></pre></td></tr></table>
</div>
</div>
<h3 id="数据库操作-flask-shell">数据库操作 （flask shell）</h3>

<p><strong>创建表</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></pre></td>
<td class="lntd">
<pre class="chroma">&gt;&gt;&gt; from hello import db
&gt;&gt;&gt; db.create_all()
# 如果数据库文件已经存在，暴力删除再重新生成：
&gt;&gt;&gt; db.drop_all()
&gt;&gt;&gt; db.create_all()</pre></td></tr></table>
</div>
</div>
<p><strong>插入行</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></pre></td>
<td class="lntd">
<pre class="chroma">&gt;&gt;&gt; from hello import Role,User
&gt;&gt;&gt; admin_role = Role(name=&#39;Admin&#39;)
&gt;&gt;&gt; mod_role = Role(name=&#39;Moderator&#39;)
&gt;&gt;&gt; user_role = Role(name=&#39;User&#39;)
&gt;&gt;&gt; user_john = User(username=&#39;john&#39;, role=admin_role)
&gt;&gt;&gt; user_susan = User(username=&#39;susan&#39;, role=user_role)
&gt;&gt;&gt; user_david = User(username=&#39;david&#39;, role=user_role)
# 数据库会话（事务）
&gt;&gt;&gt; db.session.add_all([admin_role, mod_role, user_role, user_john, user_susan, user_david])
&gt;&gt;&gt; db.session.commit()
# 数据库会话支持回滚
&gt;&gt;&gt; db.session.rollback()</pre></td></tr></table>
</div>
</div>
<p><strong>修改行</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></pre></td>
<td class="lntd">
<pre class="chroma">&gt;&gt;&gt; admin_role.name = &#39;Administrator&#39;
&gt;&gt;&gt; db.session.add(admin_role)
&gt;&gt;&gt; db.session.commit()</pre></td></tr></table>
</div>
</div>
<p><strong>删除行</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span></pre></td>
<td class="lntd">
<pre class="chroma">&gt;&gt;&gt; db.session.delete(mod_role)
&gt;&gt;&gt; db.session.commit()</pre></td></tr></table>
</div>
</div>
<p><strong>查询行</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></pre></td>
<td class="lntd">
<pre class="chroma"># 基本 all()
&gt;&gt;&gt; Role.query.all()
[&lt;Role &#39;Administrator&#39;&gt;, &lt;Role &#39;User&#39;&gt;]
&gt;&gt;&gt; User.query.all()
[&lt;User &#39;john&#39;&gt;, &lt;User &#39;susan&#39;&gt;, &lt;User &#39;david&#39;&gt;]

# 过滤器
&gt;&gt;&gt; User.query.filter_by(role=user_role).all()
[&lt;User &#39;susan&#39;&gt;, &lt;User &#39;david&#39;&gt;]

# 查看生成的原生 SQL 语句
&gt;&gt;&gt; str(User.query.filter_by(role=user_role))
&#39;SELECT users.id AS users_id, users.username AS users_username, users.role_id AS users_role_id \nFROM users \nWHERE ? = users.role_id&#39;

# 如果中途退出 shell 会话，加载示例：
user_role = Role.query.filter_by(name=&#39;User&#39;).first()

# 关闭自动执行查询
&gt;&gt;&gt; user_role.users
[&lt;User &#39;susan&#39;&gt;, &lt;User &#39;david&#39;&gt;]
# 在模型中加入 lazy=&#39;dynamic&#39; 参数
users = db.relationship(&#39;User&#39;, backref=&#39;role&#39;, lazy=&#39;dynamic&#39;)
# 可以使用过滤器了
&gt;&gt;&gt; user_role.users.order_by(User.username).all()
[&lt;User &#39;david&#39;&gt;, &lt;User &#39;susan&#39;&gt;]</pre></td></tr></table>
</div>
</div>
<h3 id="集成-python-shell">集成 Python shell</h3>

<p>通过 <code>app.shell_context_processor</code> 装饰器，在每次启动 <code>flask shell</code> 会话时自动导入数据库示例和模型：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="nd">@app.shell_context_processor</span>
<span class="k">def</span> <span class="nf">make_shell_context</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">User</span><span class="o">=</span><span class="n">User</span><span class="p">,</span> <span class="n">Role</span><span class="o">=</span><span class="n">Role</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p><br/></p>

<h2 id="第-6-章-电子邮件">第 6 章 电子邮件</h2>

<p>使用 Flask-Mail 提供电子邮件支持，Python 的 <code>smtplib</code> 库不支持 OAuth2 验证方法，需要设置 Google 账户的「允许不够安全的应用的访问权限」。</p>

<p>配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></pre></td>
<td class="lntd">
<pre class="chroma">app.config[&#39;MAIL_SERVER&#39;] = &#39;smtp.gmail.com&#39;
app.config[&#39;MAIL_PORT&#39;] = 587
app.config[&#39;MAIL_USE_TLS&#39;] = True
app.config[&#39;MAIL_USERNAME&#39;] = os.environ.get(&#39;MAIL_USERNAME&#39;)
app.config[&#39;MAIL_PASSWORD&#39;] = os.environ.get(&#39;MAIL_PASSWORD&#39;)
app.config[&#39;FLASKY_MAIL_SUBJECT_PREFIX&#39;] = &#39;[前缀]&#39;
app.config[&#39;FLASKY_MAIL_SENDER&#39;] = &#39;Flasky Admin &lt;xxx@gmail.com&gt;&#39;
app.config[&#39;FLASKY_ADMIN&#39;] = os.environ.get(&#39;FLASKY_ADMIN&#39;)</pre></td></tr></table>
</div>
</div>
<p>将敏感信息写入环境变量：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></pre></td>
<td class="lntd">
<pre class="chroma">$ export MAIL_USERNAME=xxx@gmail.com       
$ export MAIL_PASSWORD=xxxxxxxx               
$ export FLASKY_ADMIN=xxx@gmail.com # 接收邮件的管理员</pre></td></tr></table>
</div>
</div>
<p>集成邮件发送功能：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">flask_mail</span> <span class="kn">import</span> <span class="n">Mail</span><span class="p">,</span> <span class="n">Message</span>
<span class="n">mail</span> <span class="o">=</span> <span class="n">Mail</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">send_email</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">subject</span><span class="p">,</span> <span class="n">template</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;FLASKY_MAIL_SUBJECT_PREFIX&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">subject</span><span class="p">,</span>
                  <span class="n">sender</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;FLASKY_MAIL_SENDER&#39;</span><span class="p">],</span>
                  <span class="n">recipients</span><span class="o">=</span><span class="p">[</span><span class="n">to</span><span class="p">])</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">html</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span> <span class="o">+</span> <span class="s1">&#39;.html&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">mail</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>编写视图函数：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># ...</span>
<span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;FLASKY_ADMIN&#39;</span><span class="p">]:</span>
    <span class="n">send_email</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;FLASKY_ADMIN&#39;</span><span class="p">],</span> <span class="s1">&#39;New User&#39;</span><span class="p">,</span> <span class="s1">&#39;mail/new_user&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
<span class="c1"># ...</span></code></pre></td></tr></table>
</div>
</div>
<h2 id="第-7-章-大型应用的结构">第 7 章 大型应用的结构</h2>

<blockquote>
<p>提供一个可供中大型程序使用的应用结构</p>
</blockquote>

<h4 id="项目结构">项目结构：</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></pre></td>
<td class="lntd">
<pre class="chroma">.
├── app/
│   ├── /__init__.py  
│   ├── /email.py
│   ├── /models.py
│   ├── /static/
│   ├── /templates/
│   ├── /main/
│      ├── /__init__.py
│      ├── /errors.py	
│      ├── /forms.py
│      ├── /views.py
├── migrations/
├── tests/
└── venv/
├── config.py
├── flasky.py
├── requirements.txt</pre></td></tr></table>
</div>
</div>
<p>编写配置模块，配合工厂函数可以创建多个实例，便于测试。</p>

<p>Flask 提供蓝本(blueprint)功能，蓝本中定义的路由和错误处理程序处于休眠状态，直到蓝本注册到应用上后才生效。</p>

<p>定义相关的环境变量启动 Flask：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></pre></td>
<td class="lntd">
<pre class="chroma">$ export FLASKY_ADMIN=xxx@xxx.com
$ export MAIL_USERNAME=xxx@xxx.com
$ export MAIL_PASSWORD=xxx

$ export FLASK_APP=flasky.py
$ export FLASK_DEBUG=1

$ flask run</pre></td></tr></table>
</div>
</div>
<h4 id="需求文件-requirements-txt">需求文件 requirements.txt</h4>

<p>用 pip 生成 requirements.txt 文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">$ pip freeze &gt;requirements.txt</pre></td></tr></table>
</div>
</div>
<p>安装或升级包后，需手动更新。</p>

<p>其他人利用 requirements.txt 文件创建副本，先创建好虚拟环境，执行以下命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><span class="lnt">1
</span></pre></td>
<td class="lntd">
<pre class="chroma">$ pip install -r requirements.txt</pre></td></tr></table>
</div>
</div>
<h4 id="蓝本">蓝本</h4>

<p><a href="https://spacewander.github.io/explore-flask-zh">Flask 之旅</a></p>

<p><a href="https://www.zhihu.com/question/31748237">如何理解Flask中的蓝本</a></p>

<p>​</p>

<h2 id="第-8-章-用户身份验证">第 8 章 用户身份验证</h2>

<blockquote>
<p>实现用户身份验证系统</p>
</blockquote>

<h2 id="涉及到的-pip-包">涉及到的 pip 包</h2>

<p>第一部分：1~7 章</p>

<ul>
<li>flask</li>
<li>Jinja2（模板引擎）</li>
<li>flask-bootstrap（集成 BootStrap）</li>
<li>flask-moment（将 moment.js 集成到 Jinja2 模板）</li>
<li>flask-wtf（Web表单）</li>
<li>flask-sqlachemy（数据库管理）</li>
<li>flask-migrate（数据库迁移）</li>
<li>flask-mail（电子邮件）</li>
</ul>

<p>第二部分：8~14 章</p>

<ul>
<li>Flask-Login (用户身份验证)</li>
</ul>

<p>番茄计数：（按章节）</p>

<p>（一 ~ 七）　2+4+6+3+7+2+8=32</p>

<p>（八 ~ 十四）</p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Dvel</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">2019-02-22</span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">赞赏支持</label>
  <div class="qr-code">
    
    
      <label class="qr-code-image" for="reward">
        <img class="image" src="/reward/wechat-reward-image.jpg">
        <span>微信打赏</span>
      </label>
    
      <label class="qr-code-image" for="reward">
        <img class="image" src="/reward/alipay-reward-image.jpg">
        <span>支付宝打赏</span>
      </label>
  </div>
</div>

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://Dvel.xyz/tags/python/">Python</a>
          <a href="https://Dvel.xyz/tags/flask/">Flask</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/19/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">Python 数独</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/17/">
            <span class="next-text nav-default">Python 异步 IO 笔记</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  

  
  

  
  

  

  

  
  
    



        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:me@dvel.me" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/iDvel" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://www.douban.com/people/dvel/" rel="me noopener" class="iconfont"
      title="douban"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M926.917973 37.80608C959.65184 37.80608 986.19392 64.34816 986.19392 97.082027L986.19392 926.917973C986.19392 959.65184 959.65184 986.19392 926.917973 986.19392L97.082027 986.19392C64.34816 986.19392 37.80608 959.65184 37.80608 926.917973L37.80608 97.082027C37.80608 64.34816 64.34816 37.80608 97.082027 37.80608zM176.653653 176.19968 176.653653 252.678827 825.658027 252.678827 825.658027 176.19968zM217.719467 316.146347 217.719467 628.08064 273.524053 628.08064 341.292373 770.39616 157.259093 770.39616 157.259093 845.417813 842.949973 845.417813 842.949973 770.39616 654.226773 770.39616 722.899627 628.08064 783.67744 628.08064 783.67744 316.146347zM684.885333 392.891733 684.885333 553.987413 312.576 553.987413 312.576 392.891733zM570.770773 770.39616 426.653013 770.39616 359.621973 628.08064 639.443627 628.08064z"></path>
</svg>

    </a>


<a href="https://Dvel.xyz/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2016 -
    2019
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        Dvel
        
      </span></span>

  
  
    <span id="busuanzi_container">
      访客数/访问量：<span id="busuanzi_value_site_uv"></span>/<span id="busuanzi_value_site_pv"></span>
    </span>
  

  
    <span>
      冀ICP备19003122号-1	
    </span>
  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>
<script id="baidu_analytics">
  var _hmt = _hmt || [];
  (function() {
    if (window.location.hostname === 'localhost') return;
    var hm = document.createElement("script"); hm.async = true;
    hm.src = "https://hm.baidu.com/hm.js?c8cbfc925ff8dea82fe6ead2ddc2e925";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>

<script id="baidu_push">
  (function(){
    if (window.location.hostname === 'localhost') return;
    var bp = document.createElement('script'); bp.async = true;
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
      bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
      bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
  })();
</script>






  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>










</body>
</html>
